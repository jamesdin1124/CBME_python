<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>臨床教師評核系統 - EPA評核表單</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 自訂樣式 -->
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .epa-form {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .header h1 {
            color: #2c3e50;
        }
        .form-label {
            font-weight: 500;
        }
        .required::after {
            content: " *";
            color: red;
        }
        .btn-primary {
            background-color: #3498db;
            border-color: #3498db;
        }
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        .section-title {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
            color: #2c3e50;
        }
        .epa-rating {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 10px;
        }
        .epa-rating input[type="radio"] {
            display: none;
        }
        .epa-rating label {
            display: block;
            cursor: pointer;
            width: 100%;
            padding: 10px;
            text-align: center;
            border: 1px solid #ced4da;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .epa-rating input[type="radio"]:checked + label {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        .feedback-enhance {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="epa-form">
            <div class="header">
                <h1>臨床教師評核系統</h1>
                <h4>EPA評核表單</h4>
            </div>
            
            <div id="alertContainer"></div>
            
            <form id="epaForm">
                <!-- 基本資料區塊 -->
                <h5 class="section-title">基本資料</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="hierarchy" class="form-label required">階層</label>
                        <select class="form-select" id="hierarchy" name="hierarchy" required>
                            <option value="">請選擇階層</option>
                            <option value="UGY">醫學生 (UGY)</option>
                            <option value="PGY">PGY</option>
                            <option value="R">住院醫師 (R)</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="location" class="form-label required">地點</label>
                        <input type="text" class="form-control" id="location" name="location" required>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="student_id" class="form-label required">學生學號</label>
                        <input type="text" class="form-control" id="student_id" name="student_id" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="student_name" class="form-label required">學生姓名</label>
                        <input type="text" class="form-control" id="student_name" name="student_name" required>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="patient_id" class="form-label">病患ID</label>
                        <input type="text" class="form-control" id="patient_id" name="patient_id">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="epa_type" class="form-label required">EPA類型</label>
                        <select class="form-select" id="epa_type" name="epa_type" required>
                            <option value="">請選擇EPA類型</option>
                            <option value="病歷紀錄">病歷紀錄</option>
                            <option value="當班處置">當班處置</option>
                            <option value="住院接診">住院接診</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                </div>
                
                <!-- 臨床情境區塊 -->
                <h5 class="section-title">臨床情境</h5>
                <div class="mb-3">
                    <label for="clinical_scenario" class="form-label required">臨床情境描述</label>
                    <textarea class="form-control" id="clinical_scenario" name="clinical_scenario" rows="3" required></textarea>
                </div>
                
                <!-- 評分區塊 -->
                <h5 class="section-title">評核等級</h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label required">學生自評EPA等級</label>
                        <div class="epa-rating">
                            <div class="col-md-2">
                                <input type="radio" id="student_level_1" name="student_epa_level" value="1" required>
                                <label for="student_level_1">1</label>
                            </div>
                            <div class="col-md-2">
                                <input type="radio" id="student_level_2" name="student_epa_level" value="2">
                                <label for="student_level_2">2</label>
                            </div>
                            <div class="col-md-2">
                                <input type="radio" id="student_level_3" name="student_epa_level" value="3">
                                <label for="student_level_3">3</label>
                            </div>
                            <div class="col-md-2">
                                <input type="radio" id="student_level_4" name="student_epa_level" value="4">
                                <label for="student_level_4">4</label>
                            </div>
                            <div class="col-md-2">
                                <input type="radio" id="student_level_5" name="student_epa_level" value="5">
                                <label for="student_level_5">5</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">病患難度</label>
                        <div class="epa-rating">
                            <div class="col-md-3">
                                <input type="radio" id="difficulty_1" name="patient_difficulty" value="簡單">
                                <label for="difficulty_1">簡單</label>
                            </div>
                            <div class="col-md-3">
                                <input type="radio" id="difficulty_2" name="patient_difficulty" value="中等">
                                <label for="difficulty_2">中等</label>
                            </div>
                            <div class="col-md-3">
                                <input type="radio" id="difficulty_3" name="patient_difficulty" value="困難">
                                <label for="difficulty_3">困難</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label required">教師評核EPA等級</label>
                    <div class="epa-rating">
                        <div class="col-md-2">
                            <input type="radio" id="teacher_level_1" name="teacher_epa_level" value="1" required>
                            <label for="teacher_level_1">1</label>
                        </div>
                        <div class="col-md-2">
                            <input type="radio" id="teacher_level_2" name="teacher_epa_level" value="2">
                            <label for="teacher_level_2">2</label>
                        </div>
                        <div class="col-md-2">
                            <input type="radio" id="teacher_level_3" name="teacher_epa_level" value="3">
                            <label for="teacher_level_3">3</label>
                        </div>
                        <div class="col-md-2">
                            <input type="radio" id="teacher_level_4" name="teacher_epa_level" value="4">
                            <label for="teacher_level_4">4</label>
                        </div>
                        <div class="col-md-2">
                            <input type="radio" id="teacher_level_5" name="teacher_epa_level" value="5">
                            <label for="teacher_level_5">5</label>
                        </div>
                    </div>
                </div>
                
                <!-- 回饋區塊 -->
                <h5 class="section-title">教師回饋</h5>
                <div class="mb-3">
                    <label for="teacher_name" class="form-label required">教師姓名</label>
                    <input type="text" class="form-control" id="teacher_name" name="teacher_name" required>
                </div>
                
                <div class="mb-3">
                    <label for="feedback" class="form-label required">回饋意見</label>
                    <textarea class="form-control" id="feedback" name="feedback" rows="4" required></textarea>
                    <button type="button" class="btn btn-sm btn-outline-primary feedback-enhance" id="enhanceFeedback">自動美化回饋</button>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">提交評核</button>
                    <a href="/" class="btn btn-outline-secondary">返回首頁</a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 表單處理 JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('epaForm');
            const alertContainer = document.getElementById('alertContainer');
            const enhanceFeedback = document.getElementById('enhanceFeedback');
            
            // 增強回饋功能
            enhanceFeedback.addEventListener('click', function() {
                const feedback = document.getElementById('feedback').value.trim();
                if (!feedback) {
                    showAlert('請先填寫回饋意見再進行美化', 'warning');
                    return;
                }
                
                // 顯示處理中訊息
                enhanceFeedback.disabled = true;
                enhanceFeedback.textContent = '處理中...';
                
                // 呼叫增強API
                fetch('/enhance_text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: feedback })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('feedback').value = data.text;
                    } else {
                        showAlert(data.message || '美化回饋失敗', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('與伺服器通訊時發生錯誤', 'danger');
                })
                .finally(() => {
                    enhanceFeedback.disabled = false;
                    enhanceFeedback.textContent = '自動美化回饋';
                });
            });
            
            // 表單提交處理
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 收集表單資料
                const formData = new FormData(form);
                const formDataObj = {};
                formData.forEach((value, key) => { formDataObj[key] = value; });
                
                // 送出 AJAX 請求
                fetch('/add_epa_form', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formDataObj)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAlert(data.message, 'success');
                        form.reset();
                    } else {
                        showAlert(data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('提交評核時發生錯誤', 'danger');
                });
            });
            
            // 顯示警告訊息
            function showAlert(message, type) {
                alertContainer.innerHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                
                // 滾動到頂部
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        });
    </script>
</body>
</html> 