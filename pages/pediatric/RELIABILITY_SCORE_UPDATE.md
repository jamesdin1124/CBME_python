# 兒科評分系統修正說明

## 📋 修正日期
2024年（依據實際兒科評核表單）

## 🎯 修正目的
將評分轉換邏輯與兒科實際使用的 Google Forms 表單完全對齊，確保資料處理的準確性。

---

## 📊 兒科評核表單評分系統

### 1. 會議報告評分（5分制）

**表單選項**：
- 5 卓越
- 4 充分
- 3 尚可
- 2 稍差
- 1 不符合期待

**轉換邏輯**：直接映射為 1-5 分（已實作於 `convert_score_to_numeric()`，無需修改）

---

### 2. 可信賴程度/EPA可信賴程度（9級量表）

**兒科表單的9個標準選項**（與分數對應）：

| 選項 | 分數 | 說明 |
|------|------|------|
| 允許住院醫師在旁觀察 | 1.5 | 最低級別，開始接觸 |
| 教師在旁逐步共同操作 | 2.0 | 需要手把手指導 |
| 教師在旁必要時協助 | 2.5 | 可自行操作，隨時協助 |
| 教師可立即到場協助，事後逐項確認 | 3.0 | 可獨立執行，事後全面檢查 |
| 教師可立即到場協助，事後重點確認 | 3.3 | 可獨立執行，事後重點檢查 |
| 教師可稍後到場協助，必要時事後確認 | 3.6 | 基本可信賴，必要時確認 |
| 教師on call提供監督 | 4.0 | 高度信賴，遠端監督 |
| 教師不需on call，事後提供回饋及監督 | 4.5 | 非常信賴，事後回饋 |
| 學員可對其他資淺的學員進行監督與教學 | 5.0 | 最高級別，可教導他人 |

---

## 🔧 修正內容

### 修正檔案 1：`pages/pediatric/pediatric_analysis.py`

**位置**：`convert_reliability_to_numeric()` 函數（line 247-300）

**修正前問題**：
- 包含 `不允許學員觀察` (1.0)，但兒科表單無此選項
- 包含大量舊格式和 Level 格式（來自其他科別）
- 最低分從 1.0 開始，與兒科表單不符（兒科從 1.5 開始）

**修正後**：
- ✅ 兒科表單的9個選項均正確對應
- ✅ 移除 Level I-V 等舊格式（不在兒科表單中）
- ✅ 保留向下相容性（舊資料中的「不允許學員觀察」等仍可轉換）
- ✅ 最低分從 1.5 開始

**修正後的 mapping**：
```python
def convert_reliability_to_numeric(reliability_text):
    """將可信賴程度轉換為數值（兒科專用，9級量表 → 1.5-5.0分）"""
    # 兒科評核表單對應（主要）
    reliability_mapping = {
        # 9級量表（兒科表單標準選項，從1.5分開始）
        '允許住院醫師在旁觀察': 1.5,
        '教師在旁逐步共同操作': 2.0,
        '教師在旁必要時協助': 2.5,
        '教師可立即到場協助，事後逐項確認': 3.0,
        '教師可立即到場協助，事後重點確認': 3.3,
        '教師可稍後到場協助，必要時事後確認': 3.6,
        '教師on call提供監督': 4.0,
        '教師不需on call，事後提供回饋及監督': 4.5,
        '學員可對其他資淺的學員進行監督與教學': 5.0,

        # 向下相容：舊資料可能的格式變體
        '不允許學員觀察': 1.0,  # 舊資料（兒科表單已無此選項）
        '學員在旁觀察': 1.5,
        '允許學員在旁觀察': 1.5,
        '教師在旁必要時協助 ': 2.5,  # 尾部空格
        '教師可立即到場協助，事後須再確認': 3.0,
        '教師可稍後到場協助，重點須再確認': 4.0,
        '我可獨立執行': 5.0,
    }
```

---

### 修正檔案 2：`generate_pediatric_test_data.py`

**位置**：`RELIABILITY_LEVELS` 字典定義

**修正前問題**：
- 包含 `不允許學員觀察` (1.0)
- 包含 `學員在旁觀察` (1.5)（兒科表單用語為「允許住院醫師在旁觀察」）
- EPA 生成邏輯中允許分數低至 1.0

**修正後**：
- ✅ 使用兒科表單的9個標準選項
- ✅ EPA 生成邏輯限制分數範圍為 1.5-5.0
- ✅ 操作技術評核的索引區間涵蓋所有9個級別

**修正後的 RELIABILITY_LEVELS**：
```python
# 可信賴程度選項（對應數值）- 兒科表單9級量表
RELIABILITY_LEVELS = {
    '允許住院醫師在旁觀察': 1.5,
    '教師在旁逐步共同操作': 2.0,
    '教師在旁必要時協助': 2.5,
    '教師可立即到場協助，事後逐項確認': 3.0,
    '教師可立即到場協助，事後重點確認': 3.3,
    '教師可稍後到場協助，必要時事後確認': 3.6,
    '教師on call提供監督': 4.0,
    '教師不需on call，事後提供回饋及監督': 4.5,
    '學員可對其他資淺的學員進行監督與教學': 5.0
}
```

**EPA 分數範圍修正**：
```python
# 修正前
score = max(1.0, min(5.0, score))  # 限制在 1-5

# 修正後
score = max(1.5, min(5.0, score))  # 限制在 1.5-5（兒科表單範圍）
```

---

## ✅ 驗證結果

### 測試資料生成驗證

```
✅ 涵蓋級別數：9 / 9
✅ 所有9個級別均已涵蓋

【操作技術 - 可信賴程度】
共 314 筆記錄，涵蓋所有9個級別

【EPA - EPA可信賴程度】
共 278 筆記錄，涵蓋所有9個級別

【會議報告評分】
共 63 筆記錄，使用標準 5 分制
```

### 語法驗證
```
✅ pediatric_analysis.py 語法驗證通過
✅ generate_pediatric_test_data.py 執行成功
```

---

## 📌 注意事項

### 1. 向下相容性
修正後的 `convert_reliability_to_numeric()` 仍保留舊格式的支援：
- `不允許學員觀察` → 1.0（舊資料）
- `學員在旁觀察` → 1.5（舊資料）
- 其他舊格式變體

這確保歷史資料仍可正確轉換。

### 2. 與其他科別的差異
- **家醫部**：可能使用 10 級量表（含 Level I-V 格式）
- **兒科**：使用 9 級量表（1.5-5.0），無 Level 格式
- 各科別的轉換邏輯應獨立維護

### 3. CCC 門檢標準
修正後，CCC 門檢標準保持不變：
- 🟢 GREEN：≥ 3.5 分
- 🟡 YELLOW：≥ 2.5 分
- 🔴 RED：< 2.5 分

這些門檢值適用於兒科的 1.5-5.0 分範圍。

---

## 🔄 使用測試資料

### 啟用測試模式
1. 進入小兒部評核系統
2. 勾選右上角「🧪 使用測試資料」checkbox
3. 系統自動載入測試資料（627筆記錄，5位虛擬住院醫師）

### 重新生成測試資料
```bash
cd "/Users/mbpr/Library/Mobile Documents/com~apple~CloudDocs/程式開發/Python專案/Python/CBME_python"
python3 generate_pediatric_test_data.py
```

---

## 📞 問題排查

**Q: 為什麼兒科沒有 1.0 分（不允許學員觀察）？**
A: 兒科表單設計從「允許住院醫師在旁觀察」(1.5) 開始，認為住院醫師至少應該有觀察的機會。1.0 分的「不允許觀察」在兒科訓練中不適用。

**Q: 舊資料中有 1.0 分怎麼辦？**
A: 系統保留向下相容，舊資料的 1.0 分仍可正確轉換，不影響歷史記錄的顯示。

**Q: 如何確認我的資料使用正確的評分標準？**
A: 在 Tab 3「資料概覽」中檢查原始資料，確認「可信賴程度」和「EPA可信賴程度」欄位的值是否為兒科表單的9個標準選項之一。
